<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR æ‹›è´¢çŒ« 2025</title>

  <!-- MediaPipeï¼ˆéæ¨¡å—è„šæœ¬ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" defer></script>

  <!-- Three.js ä»¥åŠ GLTFLoaderï¼ˆå…¨å±€å½¢å¼ï¼Œä¸ç”¨ importï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }

    /* æ‘„åƒå¤´å°çª— */
    #input-video {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 110px;
      border-radius: 10px;
      border: 2px solid rgba(255, 215, 0, 0.6);
      transform: scaleX(-1);
      z-index: 20;
      opacity: 0.85;
      background: #111;
    }

    #three-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #ui-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 15;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #status-pill {
      margin-top: 40px;
      padding: 8px 22px;
      border-radius: 32px;
      background: rgba(12, 12, 12, 0.9);
      border: 1px solid rgba(255, 215, 0, 0.5);
      color: #ffd700;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.6);
    }

    #guide-panel {
      position: absolute;
      bottom: 38px;
      display: flex;
      gap: 18px;
      background: rgba(0, 0, 0, 0.8);
      padding: 12px 26px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
    }

    .guide-item {
      text-align: center;
      color: rgba(255, 255, 255, 0.85);
      font-size: 12px;
      line-height: 1.3;
    }

    .guide-icon {
      font-size: 24px;
      display: block;
      margin-bottom: 2px;
    }

    #loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 200;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #ffd700;
    }

    .spinner {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: 3px solid #333;
      border-top: 3px solid #ffd700;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <!-- æ‘„åƒå¤´ç”»é¢ -->
  <video id="input-video" playsinline></video>

  <!-- Three.js ç”»å¸ƒ -->
  <canvas id="three-canvas"></canvas>

  <!-- UI å±‚ -->
  <div id="ui-layer">
    <div id="status-pill">
      <span id="gesture-icon">ğŸ‘€</span>
      <span id="gesture-text">æ­£åœ¨å¯»æ‰¾ä½ çš„æ‰‹åŠ¿...</span>
    </div>

    <div id="guide-panel">
      <div class="guide-item">
        <span class="guide-icon">âœŠ</span>
        æŠ“å–æ”¾å¤§
      </div>
      <div class="guide-item">
        <span class="guide-icon">ğŸ–</span>
        å¼ å¼€ç¼©å°
      </div>
      <div class="guide-item">
        <span class="guide-icon">âœŒï¸</span>
        æ—‹è½¬æ‹›è´¢çŒ«
      </div>
    </div>
  </div>

  <!-- Loading è’™å±‚ -->
  <div id="loading">
    <div class="spinner"></div>
    <div style="margin-top: 14px;">åŠ è½½æ‹›è´¢çŒ«æ¨¡å‹ä¸­...</div>
  </div>

  <!-- éšè—å›¾ç‰‡èµ„äº§ï¼ˆé¢„ç•™ï¼‰ -->
  <div style="display:none">
    <img id="img-santa" src="./santa.png" alt="santa">
    <img id="img-tree" src="./tree.png" alt="tree">
  </div>

  <!-- ä¸»é€»è¾‘è„šæœ¬ï¼šä¸ä½¿ç”¨ importï¼Œä¸ä½¿ç”¨ type="module" -->
  <script>
    let scene, camera, renderer;
    let catModel = null;
    let targetScale = 1.0;
    let targetRotationY = 0;

    function initThree() {
      const canvas = document.getElementById("three-canvas");

      renderer = new THREE.WebGLRenderer({
        canvas: canvas,
        antialias: true,
        alpha: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

      scene = new THREE.Scene();
      scene.background = new THREE.Color("#000000");

      camera = new THREE.PerspectiveCamera(
        45,
        window.innerWidth / window.innerHeight,
        0.1,
        100
      );
      camera.position.set(0, 1.2, 6);

      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambient);

      const dir = new THREE.DirectionalLight(0xffffff, 1.2);
      dir.position.set(3, 5, 5);
      dir.castShadow = true;
      scene.add(dir);

      const groundGeo = new THREE.PlaneGeometry(15, 15);
      const groundMat = new THREE.MeshStandardMaterial({
        color: 0x111111,
        roughness: 0.9,
        metalness: 0.1,
      });
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = -1.5;
      scene.add(ground);

      loadCatModel();
      animate();
    }

    function loadCatModel() {
      const loader = new THREE.GLTFLoader();
      loader.load(
        "./cutecat01.glb",
        function (gltf) {
          catModel = gltf.scene;
          catModel.scale.set(2, 2, 2);
          catModel.position.set(0, -0.8, 0);
          scene.add(catModel);

          const loading = document.getElementById("loading");
          loading.style.opacity = "0";
          setTimeout(function () {
            loading.style.display = "none";
          }, 300);
        },
        undefined,
        function (error) {
          console.error("æ¨¡å‹åŠ è½½å¤±è´¥ï¼š", error);
          alert("âŒ æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤ cutecat01.glb æ˜¯å¦å­˜åœ¨ã€æ–‡ä»¶åå®Œå…¨ä¸€è‡´ã€‚");
        }
      );
    }

    function animate() {
      requestAnimationFrame(animate);

      if (catModel) {
        const currentScale = catModel.scale.x;
        const nextScale = currentScale + (targetScale - currentScale) * 0.12;
        catModel.scale.set(nextScale, nextScale, nextScale);

        catModel.rotation.y += (targetRotationY - catModel.rotation.y) * 0.08;
      }

      renderer.render(scene, camera);
    }

    function detectGesture(landmarks) {
      const dist = function (a, b) {
        return Math.hypot(a.x - b.x, a.y - b.y);
      };
      const palmSize = dist(landmarks[0], landmarks[9]);

      const isFingerOpen = function (tipIndex) {
        return dist(landmarks[tipIndex], landmarks[0]) > palmSize * 1.1;
      };

      const indexOpen = isFingerOpen(8);
      const middleOpen = isFingerOpen(12);
      const ringOpen = isFingerOpen(16);
      const pinkyOpen = isFingerOpen(20);

      const openCount = [indexOpen, middleOpen, ringOpen, pinkyOpen].filter(Boolean).length;

      if (openCount === 0) return "FIST";
      if (openCount >= 3) return "OPEN";
      if (indexOpen && middleOpen && !ringOpen) return "VICTORY";
      return "NEUTRAL";
    }

    window.onload = function () {
      initThree();

      const videoEl = document.getElementById("input-video");
      const hands = new Hands({
        locateFile: function (file) {
          return "https://cdn.jsdelivr.net/npm/@mediapipe/hands/" + file;
        },
      });

      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.5,
      });

      const iconEl = document.getElementById("gesture-icon");
      const textEl = document.getElementById("gesture-text");

      hands.onResults(function (results) {
        if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
          iconEl.innerText = "ğŸ‘€";
          textEl.innerText = "æ­£åœ¨å¯»æ‰¾ä½ çš„æ‰‹åŠ¿...";
          targetScale = 1.0;
          targetRotationY = 0;
          return;
        }

        const lm = results.multiHandLandmarks[0];
        const gesture = detectGesture(lm);

        const palmX = lm[9].x;
        const offset = (palmX - 0.5) * 1.5;

        if (gesture === "FIST") {
          iconEl.innerText = "âœŠ";
          textEl.innerText = "æŠ“ä½æ‹›è´¢çŒ«ï¼šæ”¾å¤§";
          targetScale = 1.6;
          targetRotationY = offset;
        } else if (gesture === "OPEN") {
          iconEl.innerText = "ğŸ–";
          textEl.innerText = "å¼ å¼€æ‰‹æŒï¼šç¼©å°";
          targetScale = 0.8;
          targetRotationY = offset;
        } else if (gesture === "VICTORY") {
          iconEl.innerText = "âœŒï¸";
          textEl.innerText = "Victoryï¼šè®©æ‹›è´¢çŒ«è½¬èµ·æ¥";
          targetScale = 1.2;
          targetRotationY = (catModel ? catModel.rotation.y : 0) + 0.3;
        } else {
          iconEl.innerText = "âœ‹";
          textEl.innerText = "ä¿æŒå§¿åŠ¿å³å¯";
          targetScale = 1.0;
          targetRotationY = offset;
        }
      });

      const cam = new Camera(videoEl, {
        onFrame: async function () {
          await hands.send({ image: videoEl });
        },
        width: 640,
        height: 480,
      });

      cam.start();

      window.addEventListener("resize", function () {
        if (!camera || !renderer) return;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    };
  </script>
</body>
</html>